<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="angular-1.8.2/angular.min.js"></script>
    <script src="angular-1.8.2/angular-route.js"></script>
    <!-- boostrap -->


    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script> -->
    <!-- boostrap -->
    <link rel="stylesheet" href="https://unpkg.com/bs-brain@2.0.3/components/heroes/hero-5/assets/css/hero-5.css">
    <!-- <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script> -->

    <link rel="icon" type="image/x-icon" href="img/favicon-fittour-du-lich-co-gu-300x300.png">

    <title>ASM2-AngularJS-Boostrap5.3</title>
</head>

<body ng-app="myapp">
    <div ng-include="'header.html'"></div>
    <!-- Content -->


    <div ng-view>
    </div>


    <!-- Content -->


    <div ng-include="'footer.html'"></div>



    <script>
        var app = angular.module("myapp", ["ngRoute"]);
        app.config(function ($routeProvider) {
            $routeProvider
                .when("/header", { templateUrl: "header.html", controller: "dulichcoguuCrtl" })

                .when("/", { templateUrl: "home.html", controller: "dulichcoguuCrtl" })
                .when("/register", { templateUrl: "register.html", controller: "dulichcoguuCrtl" })
                .when("/login", { templateUrl: "login.html", controller: "dulichcoguuCrtl" })
                .when("/blog", { templateUrl: "blog.html", controller: "dulichcoguuCrtl" })
                .when("/contact", { templateUrl: "contact.html", controller: "dulichcoguuCrtl" })
                .when("/gallery", { templateUrl: "gallery.html", controller: "dulichcoguuCrtl" })
                .when("/gallery-detail/:id", { templateUrl: "gallery_detail.html", controller: "dulichcoguuCrtl" })
                .when("/introduction", { templateUrl: "introduction.html", controller: "dulichcoguuCrtl" })
                .when("/lichtrinhtour", { templateUrl: "lichtrinhtour.html", controller: "dulichcoguuCrtl" })
                .when("/tours", { templateUrl: "tours.html", controller: "dulichcoguuCrtl" })
                .when("/detail/:id", { templateUrl: "detail.html", controller: "dulichcoguuCrtl" })
                .otherwise({ templateUrl: "home.html", controller: "dulichcoguuCrtl" })
        });

        // app.directive('customValidator', function () {
        //     return {
        //         require: 'ngModel',
        //         link: function (scope, element, attrs, ngModelCtrl) {

        //         }
        //     }
        // })




        app.controller("dulichcoguuCrtl", function ($scope, $route, $rootScope, $routeParams, $http, $q, $location) {
            //Khai báo 1 mảng products rỗng 
            $scope.tours = [];
            $scope.listCategory = [];
            $scope.blogs = []
            $scope.listGallery = [];
            $scope.loadLiMit = 6;
            $scope.users = [];
            $scope.currentUser = "";
            $scope.test = "";



            // lấy dữu liệu từ localStorage để xuất thông tin user lên Header
            $scope.currentUser = JSON.parse(localStorage.getItem('user_info'));
            // console.log("User2: ", $scope.currentUser);



            $scope.logout = function () {
                localStorage.removeItem('user_info');
                window.location.reload();
            };








            //Đọc dữ liệu từ json server rồi đổ mảng vào trong products    
            $http.get("https://ngothanhbinh204.github.io/apiDulichcoguu/db.json")
                .then(function (reponse) {
                    $scope.tours = reponse.data.tours;
                    // console.log($scope.tours);
                    // console.log($scope.tours.length);


                    $scope.loadMore = function () {
                        $scope.loadLiMit += 3;
                        // console.log($scope.tours);
                        // console.log($scope.tours.length);
                    }
                    $scope.collapse = function () {
                        $scope.loadLiMit = 6;
                    }
                    // // Pagination
                    // $scope.currentPage = 1;
                    // $scope.toursPerPage = 3; // số tour/mỗi trang

                    // $scope.pageChanged = function () {
                    //     // logic hiển thị tour trên trang hiện tại
                    //     let begin = (($scope.currentPage - 1) * $scope.toursPerPage);
                    //     let end = begin + $scope.toursPerPage

                    //     $scope.filteredItems = $scope.tours.slice(begin, end);
                    //     // console.log($scope.filteredItems);
                    // };

                    // $scope.pageChanged();

                    // $scope.search = function () {
                    //     // Gọi hàm tính toán trang mới khi tìm kiếm
                    //     $scope.currentPage = 1;
                    //     $scope.pageChanged();
                    // };

                    // // Button Begin 
                    // $scope.beginPage = function () {
                    //     $scope.currentPage = 1;
                    //     $scope.pageChanged();
                    // }
                    // // Button Prev
                    // $scope.prevPage = function () {
                    //     $scope.currentPage--;
                    //     $scope.pageChanged();
                    // };
                    // // Button Next
                    // $scope.nextPage = function () {
                    //     $scope.currentPage++;
                    //     $scope.pageChanged();
                    //     console.log($scope.currentPage);
                    // };
                    // // Button End
                    // $scope.endPage = function () {
                    //     $scope.currentPage = Math.ceil($scope.tours.length / $scope.toursPerPage);
                    //     $scope.pageChanged();
                    //     console.log($scope.currentPage);
                    // }
                    // // Page total
                    // $scope.totalPages = function () {
                    //     $scope.totalpage = Math.ceil($scope.tours.length / $scope.toursPerPage);
                    //     return Math.ceil($scope.tours.length / $scope.toursPerPage);
                    // };
                    // console.log($scope.totalPages());

                    //    // Pagination

                    // Lấy sản phẩm chi tiết thông qua id truyền vào routeParams
                    $scope.detailTour = $scope.tours.find(item => item.id == $routeParams.id);
                });

            // GET USERS
            $http.get("http://localhost:3000/users")
                .then(function (reponse) {
                    $scope.users = reponse.data.users;
                    //   console.log($scope.users);

                    // $scope.detailTour = $scope.category.find(item => item.id == $routeParams.id);
                });

            $http.get("http://localhost:3000/listCategory")
                .then(function (reponse) {
                    $scope.listCategory = reponse.data;
                    //  console.log($scope.listCategory);
                    // Lọc danh mục Tour


                    // $scope.detailTour = $scope.category.find(item => item.id == $routeParams.id);
                });
            $http.get("https://localhost:3000/blogs")
                .then(function (reponse) {
                    $scope.blogs = reponse.data;
                    // console.log($scope.blogs);
                    // $scope.detailTour = $scope.category.find(item => item.id == $routeParams.id);
                });
            $http.get("http://localhost:3000/listGallery")
                .then(function (reponse) {
                    $scope.listGallery = reponse.data;
                    // console.log($scope.listGallery);
                    $scope.galleryDetail = $scope.listGallery.find(item => item.id == $routeParams.id);
                });

            $http.get('https://ngothanhbinh204.github.io/apiDulichcoguu/db.json')
                .then(function (response) {
                    // Kiểm tra dữ liệu phản hồi
                    //   console.log("API Response: ", response);

                    // Truy cập dữ liệu phản hồi
                    $scope.tours = response.data.tours;
                    $scope.listCategory = response.data.listCategory;

                    // console.log("API Tours: ", $scope.tours);
                    // console.log("API List Category: ", $scope.listCategory);
                    // // Xử lý dữ liệu toursResponse và categoriesResponse tại đây
                    // console.log('Dữ liệu tours:', $scope.tours);
                    // console.log('Dữ liệu danh mục:', $scope.listCategory);

                    // Lọc sản phẩm theo Danh Mục
                    $scope.selectedCategory = '';
                    $scope.filteredTours = $scope.tours;
                    $scope.filterTours = function () {
                        if ($scope.selectedCategory) {
                            $scope.filteredTours = $scope.tours.filter(tour => tour.cateid == $scope.selectedCategory);
                            // console.log($scope.selectedCategory);
                            // console.log($scope.filteredTours);
                        } else {
                            $scope.filteredTours = $scope.tours;
                        }
                    };
                })
                .catch(function (error) {
                    // Xử lý lỗi nếu có
                    console.error('Đã xảy ra lỗi:', error);
                });



        });


        // Controller Other -------------------------------

        // Controller Register
        app.controller("registerCtrl", function ($scope, $rootScope, $http, $routeParams) {
            // Register

            $scope.user = {};
            $scope.userRegister = [];
            $scope.showPassword = false;
            $scope.alertReqSuccess = localStorage.getItem('alertReqSuccess');
            $scope.alertReqFail = localStorage.getItem('alertReqFail');
            $scope.showAlertReqFail = false;
            $scope.alertName = "";
            $scope.alertEmail = "";
            $scope.alertPhone = "";

            // Tên Lỗi
            $scope.errorNameMessage = ''; // Biến chứa thông báo lỗi
            $scope.errorEmailMessage = ''; // Biến chứa thông báo lỗi
            $scope.errorPhoneMessage = ''; // Biến chứa thông báo lỗi

            // Hiện lỗi
            $scope.showErrorNameMessage = false; // Biến điều khiển hiển thị thông báo lỗi
            $scope.showErrorEmailMessage = false; // Biến điều khiển hiển thị thông báo lỗi
            $scope.showErrorPhoneMessage = false; // Biến điều khiển hiển thị thông báo lỗi

            // Ẩn lỗi
            $scope.hideErrorMessage = function () {
                $scope.showErrorNameMessage = false;
                $scope.showErrorEmailMessage = false;
                $scope.showErrorPhoneMessage = false;
                $scope.showAlertReqFail = false;

            }

            // Nếu có, hiển thị thông báo và xóa khỏi localStorage
            if ($scope.alertReqSuccess) {
                //  console.log($scope.alertReqSuccess); // Debug
                localStorage.removeItem('alertReqSuccess');
            }

            // Nếu có, hiển thị thông báo và xóa khỏi localStorage
            if ($scope.alertReqFail) {
                localStorage.removeItem('alertReqFail');
            }

            // click showpassword
            $scope.eyesClick = function () {
                $scope.showPassword = !$scope.showPassword;
            };

            // Hàm getUserDataRegister : xử lí bất đồng bộ 
            $scope.getUserDataRegister = function (callback) {
                $http.get("http://localhost:3000/users")
                    .then(function (reponse) {
                        callback(reponse.data)
                    })
                    .catch(function (error) {
                        console.error('lỗi lấy dữ liệu user:', error);
                        callback(null, error);
                    });
            }

            // đăng ký start
            $scope.register = function (event) {
                event.preventDefault();
                $scope.getUserDataRegister(function (userData, error) {
                    if (userData) {
                        $scope.userRegister = userData;
                        console.log("userRegisterAPi2: ", $scope.userRegister);
                        var tonTaiUser = false;
                        angular.forEach($scope.userRegister, function (user) {
                            var usernameValue = $scope.user.username;
                            var passwordValue = $scope.user.password;
                            var emailValue = $scope.user.email;
                            var phoneValue = $scope.user.phone;
                            // console.log("username: ", usernameValue);
                            // console.log("username: ", passwordValue);
                            // console.log("username: ", emailValue);
                            // console.log("username: ", phoneValue);
                            if (user.username === usernameValue || user.email === emailValue || user.phone === phoneValue) {
                                // tồn Tại -> Lỗi
                                $scope.alertReqFail = "Tài khoản đã tồn tại";
                                localStorage.setItem('alertReqFail', 'Tài khoản đã tồn tại');
                                $scope.showAlertReqFail = true;

                                tonTaiUser = true; // khi tìm thấy người dùng
                                console.log('Tài khoản tồn tại');
                                if (user.username === usernameValue) {
                                    $scope.errorNameMessage = "Tên tài khoản đã tồn tại";
                                    $scope.showErrorNameMessage = true; // Hiển thị thông báo lỗi
                                }
                                if (user.email === emailValue) {
                                    $scope.errorEmailMessage = "Email tài khoản đã tồn tại";
                                    $scope.showErrorEmailMessage = true; // Hiển thị thông báo lỗi                                
                                }
                                if (user.phone === phoneValue) {
                                    $scope.errorPhoneMessage = "Số điện thoại đã tồn tại";
                                    $scope.showErrorPhoneMessage = true; // Hiển thị thông báo lỗi  
                                }
                                return; // stop loop
                            }

                        });

                        if (!tonTaiUser) {
                            // bắt đầu đăng ký
                            fetch('http://localhost:3000/users', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify($scope.user),
                            })
                                .then(response => {
                                    if (response.ok) {
                                        $scope.alertRegister = "Đăng Ký Thành Công !!!";
                                        localStorage.setItem('alertReqSuccess', 'Đăng Ký Thành Công !!!');
                                    } else {
                                        throw new Error('Đăng ký thất bại');
                                    }
                                })
                                .catch(error => {
                                    localStorage.setItem('alertReqFail', 'Đăng Ký Thất Bại !!!');
                                    $scope.alertRegister = "Đăng Ký Thất Bại";
                                    console.error('Error registering user:', error);
                                });
                            console.log("Người dùng Pass");
                        }
                    } else {
                        console.error('lỗi lấy dữ liệu user - 2:', error);
                    }
                });
            }

            // đăng ký END
        });


        // End Controller Register


        // Cotnroller Login
        app.controller("loginCtrl", function ($scope, $rootScope, $http, $routeParams, $location) {

            // show password

            $scope.userLoginPass = null;
            $scope.usernameError = "";
            $scope.passwordError = "";
            $scope.userLogin = [];
            $scope.showPassword = false;
            // click showpassword
            $scope.eyesClick = function () {
                $scope.showPassword = !$scope.showPassword;
            };

            $http.get("http://localhost:3000/users")
                .then(function (reponse) {
                    $scope.userLogin = reponse.data;
                    console.log("userloginAPi: ", $scope.userLogin);
                });

            $scope.login = function (username, password) {
                var userFound = false;
                angular.forEach($scope.userLogin, function (user) {
                    if (user.username === username) {
                        userFound = true;
                        if (user.password === password) {
                            $scope.userLoginPass = user;
                            // Login Pass
                            console.log("Đăng Nhập Thành Công: ", $scope.userLoginPass);
                            // Đăng Nhập thành công lưu thông tin người dùng vào LocalStorage
                            localStorage.setItem('user_info', JSON.stringify($scope.userLoginPass));
                            //window.location.reload();

                            $location.url('/'); // Chuyển hướng tới trang index
                            // setTimeOut sau khi chuyển trang -> reload
                            setTimeout(function () {
                                window.location.reload(); // Reload trang sau 100ms (hoặc một khoảng thời gian ngắn đủ để trình duyệt bắt đầu chuyển hướng)
                            }, 500);
                            // window.location.reload();
                            $window.location.href = '/';
                            return;
                        } else {
                            // password Wrong
                            $scope.passwordError = "Mật khẩu người dùng không đúng";
                            console.log("userArrr = ", user);
                            return;
                        }
                    }
                });

                if (!userFound) {
                    // Username not found
                    $scope.usernameError = "Tên người dùng không đúng";
                }

            }
        });

        // End Cotnroller Login


    </script>
    <script src="js/style.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>

</body>

</html>